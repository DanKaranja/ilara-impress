<tal:report
  i18n:domain="senaite.publisher"
  define="collection python:view.collection;
          tool python:view.get_report_tool('AnalysisRequest')">

  <tal:css define="laboratory view/laboratory;">
    <style type="text/css">
     html, body { font-size: 1em; }
     h1 { font-size: 160%; }
     h2 { font-size: 120%; }
     .colon-after:after { content: ":"; }
     table.noborder td { border: none; }
     table.nopadding td { padding: 0; }
     table td.label { padding-right: 0.3rem; }
     table td.label { white-space: nowrap; }
     @page {
       @bottom-left {
         font-size: 9pt;
         content: '<span tal:omit-tag="" tal:content="laboratory/Name"/>';
       }
       @bottom-center {
         font-size: 9pt;
         <tal:single tal:condition="python:len(collection) == 1">
           content: '<tal:content replace="python:collection[0].getId()"/>';
         </tal:single>
         <tal:multi tal:condition="python:len(collection) > 1">
           content: '<tal:content replace="python:', '.join(map(lambda m: m.getId(), collection))"/>';
         </tal:multi>
       }
       @bottom-right {
         font-size: 9pt;
         content: "<tal:t i18n:translate=''>Page</tal:t> " counter(page) " <tal:t i18n:translate=''>of</tal:t> " counter(pages);
       }
     }
    </style>
  </tal:css>

  <!-- Iterate over all models of the collection -->
  <tal:models repeat="model collection">
    <!-- get the reportview of each model -->
    <tal:model define="reportview python:view.get_reportview_for(model);">

      <!-- HEADER -->
      <tal:render condition="repeat/model/start">
        <div class="row section-header">
          <div class="col-sm-12">
            <div class="text-right">
              <a tal:attributes="href reportview/portal_url">
                <img style="max-height: 100px"
                     tal:attributes="src python:reportview.get_image_resource('logo_print.png', prefix='')"/>
              </a>
            </div>
          </div>
        </div>
      </tal:render>

      <!-- INFO -->
      <tal:render condition="repeat/model/start"
                  define="client model/Client;
                          sample model/Sample;">

        <div class="row section-info">
          <div class="col-sm-12 py-4 small">
            <!-- Client Info -->
            <table class="col">
              <colgroup>
                <col style="width:50%"/>
                <col style="width:50%"/>
              </colgroup>
              <tr>
                <td class="align-top">
                  <!-- Left Table -->
                  <table class="table table-sm mr-1">
                    <!-- Client Name -->
                    <tr>
                      <td class="label" i18n:translate="">Client</td>
                      <td class="field" tal:content="model/Client/Name"></td>
                    </tr>
                    <!-- Client Reference -->
                    <tr>
                      <td class="label" i18n:translate="">Client Reference</td>
                      <td class="field" tal:content="model/ClientReference"></td>
                    </tr>
                    <!-- Client Order -->
                    <tr>
                      <td class="label" i18n:translate="">Client Order</td>
                      <td class="field" tal:content="model/ClientOrderNumber|nothing"></td>
                    </tr>
                    <!-- Client Sample ID -->
                    <tr>
                      <td class="label" i18n:translate="">Client Sample ID</td>
                      <td class="field" tal:content="model/ClientSampleID"></td>
                    </tr>
                  </table>
                </td>
                <td class="align-top">
                  <!-- Right Table -->
                  <table class="table table-sm ml-1">
                    <!-- Sample Type -->
                    <tr>
                      <td class="label" i18n:translate="">Sample Type</td>
                      <td class="field" tal:content="sample/SampleType/title|nothing"></td>
                    </tr>
                    <!-- Sample Point -->
                    <tr>
                      <td class="label" i18n:translate="">Sample Point</td>
                      <td class="field" tal:content="sample/SamplePoint/Title|nothing"></td>
                    </tr>
                    <!-- Sample Remarks -->
                    <tr>
                      <td class="label" i18n:translate="">Sample Remarks</td>
                      <td tal:content="model/getSamplingDeviationTitle"></td>
                    </tr>
                    <!-- Date Sampled -->
                    <tr>
                      <td class="label" i18n:translate="">Date Sampled</td>
                      <td class="field" tal:content="python:reportview.to_localized_time(model.DateSampled)"></td>
                    </tr>
                    <!-- Date Received -->
                    <tr>
                      <td class="label" i18n:translate="">Date Received</td>
                      <td class="field"
                          tal:define="date_received python:model.DateReceived"
                          tal:content="python:reportview.to_localized_time(date_received)"></td>
                    </tr>
                    <!-- Date Analyzed -->
                    <tr>
                      <td class="label" i18n:translate="">Date Analyzed</td>
                      <td class="field"
                          tal:define="date_analyzed python:model.get_transition_date('bika_ar_workflow', 'to_be_verified')"
                          tal:content="python:reportview.to_localized_time(date_analyzed)"></td>
                    </tr>
                    <!-- Date Verified -->
                    <tr>
                      <td class="label" i18n:translate="">Date Verified</td>
                      <td class="field"
                          tal:define="date_verified python:model.get_transition_date('bika_ar_workflow', 'verify')"
                          tal:content="python:reportview.to_localized_time(date_verified)"></td>
                    </tr>
                    <!-- Date Published -->
                    <tr>
                      <td class="label" i18n:translate="">Date Published</td>
                      <td class="field"
                          tal:define="date_published python:model.DatePublished"
                          tal:content="python:reportview.to_localized_time(date_published)"></td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </tal:render>


      <!-- RESULTS -->
      <tal:render condition="repeat/model/start"
                  define="analyses_by_poc python:tool.get_analyses_by_poc(collection);
                          categories_by_poc python:tool.get_categories_by_poc(collection)">
        <div class="row section-results">
          <div class="col col-sm-12">
            <h1 i18n:translate="">Results</h1>

            <!-- Point of Captures -->
            <tal:poc tal:repeat="poc analyses_by_poc">
              <h4 tal:content="python:reportview.points_of_capture.get(poc)"></h4>

              <!-- Results table per PoC -->
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th i18n:translate="">Category</th>
                    <th tal:repeat="model collection">
                      <span tal:content="model/getId"/>
                    </th>
                  </tr>
                </thead>
                <tbody>
                <!-- Categories in PoC -->
                <tal:categories_in_poc tal:repeat="category categories_by_poc">
                  <tr>
                    <td class="font-weight-bold table-warning"
                        tal:attributes="colspan python:len(collection) + 1"
                        tal:content="category/Title"/>
                  </tr>
                  <tr tal:define="analyses python:tool.get_analyses_by(collection, poc=poc, category=category);
                                  analyses_by_title python:tool.group_items_by('Title', analyses)"
                      tal:repeat="analysis_title python:analyses_by_title">
                    <td tal:content="analysis_title"/>
                    <td tal:repeat="model collection">
                      <tal:analysis tal:repeat="analysis python:tool.get_analyses_by(model, title=analysis_title);">
                        <span tal:content="analysis/Result"/>
                      </tal:analysis>
                    </td>
                  </tr>
                </tal:categories_in_poc>
                </tbody>
              </table>

            </tal:poc>

          </div>
        </div>
      </tal:render>

    </tal:model>
  </tal:models>
</tal:report>
