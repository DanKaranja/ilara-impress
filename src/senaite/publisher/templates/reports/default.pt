<tal:report define="analysisrequest view/context;
                    states python: analysisrequest.getObjectWorkflowStates().values();
                    invalid analysisrequest/isInvalid;
                    valid_states python:['verified', 'published'];
                    prepublish python:not invalid and not any(map(lambda s: s in valid_states, states));
                    analyses analysisrequest/Analyses;
                    an_by_poc python:view.group_items_by('PointOfCapture', analyses);
                    an_by_cat python:view.group_items_by('getCategoryTitle', analyses);
                    sample analysisrequest/Sample;
                    batch analysisrequest/Batch;
                    client analysisrequest/Client;
                    specification analysisrequest/Specification;
                    publication_specification analysisrequest/PublicationSpecification;
                    specifications python:publication_specification or specification;
                    contact analysisrequest/Contact;

                    portal python:view.portal;
                    laboratory python:view.laboratory;

                    reporter python:None;">

  <div class="row section-header">
    <div class="col-sm-6 logo lab-logo pb-2">
      <a tal:attributes="href portal/absolute_url">
        <img style="max-width: 200px"
             tal:attributes="src python:view.get_image_resource('logo_print.png', prefix='')"/>
      </a>
    </div>

    <div class="col-sm-6 pt-2">
      <!-- Barcode -->
      <div class="text-center float-right barcode-container">
        <div class="barcode"
             data-code="code128"
             data-showHRI="true"
             data-barHeight="15"
             data-addQuietZone="true"
             tal:attributes="data-id analysisrequest/id">
        </div>
      </div>
    </div>

  </div>

  <div class="row section-info">
    <div class="col-sm-12 pt-2">
      <!-- Client Info -->
      <table class="table">
        <tr>
          <td>
            <address class="contact-address" tal:condition="contact">
              <div class="client-fullname">
                <div tal:replace="contact/Fullname|nothing"></div>
              </div>
              <div class="client-name font-weight-bold">
                <div tal:replace="client/Name|nothing"></div>
              </div>
              <div class="client-email">
                <a tal:content="contact/EmailAddress|nothing"
                   tal:attributes="href string:mailto:${contact/EmailAddress}"></a>
              </div>
              <div class="client-phone">
                <div tal:replace="contact/Phone|nothing"></div>
                <div class="client-phone">
                  <div tal:replace="contact/Fax|nothing"></div>
                </div>
              </div>
            </address>
          </td>
          <td>
            <!-- Laboratory Info -->
            <address class="laboratory-address" tal:condition="laboratory">
              <div class="lab-title font-weight-bold">
                <div tal:replace="laboratory/title|nothing"/>
              </div>
              <div class="lab-address">
              </div>
              <div class="lab-url">
                <a tal:attributes="href laboratory/LabURL"
                   tal:content="laboratory/LabURL"></a>
              </div>
              <div class="lab-supervisor" tal:condition="laboratory/Supervisor">
                <div tal:replace="laboratory/Supervisor/Fullname|nothing"/>
              </div>
            </address>

            <div tal:define="accredited laboratory/LaboratoryAccredited;
                             accreditation_logo laboratory/AccreditationBodyLogo"
                 tal:condition="accredited">
              <img tal:condition="accreditation_logo"
                   tal:attributes="src accreditation_logo/absolute_url"/>
              <img tal:condition="not:accreditation_logo"
                   tal:attributes="src python:view.get_image_resource('AccreditationBodyLogo.png')"/>
            </div>
          </td>
        </tr>
      </table>
    </div>

  </div>

  <div class="alert alert-danger" tal:condition="invalid">
    <div i18n:translate="">This Analysis Request has been invalidated due to erroneously published results</div>
    <tal:invalidreport tal:define="child analysisrequest.ChildAnalysisRequest"
                       tal:condition="child">
      <span i18n:translate="">This Analysis request has been replaced by</span>
      <a tal:attributes="href child/absolute_url"
         tal:content="child/getId"></a>
    </tal:invalidreport>
  </div>

  <div class="alert alert-danger" tal:condition="prepublish">
    <div i18n:translate="">Provisional report</div>
  </div>

  <div class="row section-summary">
    <div class="col col-sm-12">
      <h1 i18n:translate="">Summary</h1>
      <table class="table table-sm">
        <tr>
          <td style="width:20%" class="label" i18n:translate="">Request ID</td>
          <td>
            <a tal:content="analysisrequest/id"
               tal:attributes="href analysisrequest/absolute_url;">
            </a>
          </td>
        </tr>
        <tr>
          <td class="label" i18n:translate="">Sample ID</td>
          <td>
            <a tal:content="sample/id"
               tal:attributes="href sample/absolute_url">
            </a>
          </td>
        </tr>
        <tr tal:condition="batch">
          <td class="label" i18n:translate="">Batch ID</td>
          <td>
            <a tal:content="batch/id"
               tal:attributes="href batch/absolute_url">
            </a>
          </td>
        </tr>
        <tr tal:condition="batch">
          <td class="label" i18n:translate="">Client Batch ID</td>
          <td tal:content="batch/ClientBatchID"></td>
        </tr>
        <tr>
          <td class="label" i18n:translate="">Client</td>
          <td>
            <a tal:attributes="href client/absolute_url"
               tal:content="client/Name"></a>
          </td>
        </tr>
        <tr>
          <td class="label" i18n:translate="">Client SID</td>
          <td tal:content="analysisrequest/ClientSampleID"></td>
        </tr>
        <tr>
          <td class="label" i18n:translate="">Sample Type</td>
          <td tal:content="sample/SampleType/title|nothing"></td>
        </tr>
        <tr>
          <td class="label" i18n:translate="">Specification</td>
          <td tal:content="specifications/Title|nothing"></td>
        </tr>
        <tr>
          <td class="label" i18n:translate="">Date Received</td>
          <td tal:content="python:view.to_localized_time(analysisrequest.DateReceived)">09.03.2018 09:54</td>
        </tr>
        <tr>
          <td class="label" i18n:translate="">Date Published</td>
          <td tal:content="python:view.to_localized_time(analysisrequest.DatePublished)">13.03.2018 13:35</td>
        </tr>

        <tr tal:condition="reporter">
          <td class="label" i18n:translate="">Published by</td>
          <td>
            <tal:email tal:condition="reporter/email"
                       tal:define="email reporter/email">
              (<a tal:content="email"
                  tal:attributes="href string:mailto:${email}"></a>)
            </tal:email>
          </td>
        </tr>
        <tr tal:condition="python: batch and batch.BatchLabels">
          <td class="label" i18n:translate="">Batch Labels</td>
          <td tal:content="structure python:', '.join(batch.BatchLabels)"></td>
        </tr>
      </table>
    </div>
  </div>

  <div class="row section-results">
    <div class="col col-sm-12">
      <h1 i18n:translate="">Results</h1>

      <!-- Point of Capture -->
      <tal:analyses_by_poc tal:repeat="poc python:view.get_analyses_by_poc()">
        <h2 tal:content="python:view.points_of_capture.get(poc)"></h2>

        <!-- Analysis Category -->
        <tal:categories_in_poc tal:repeat="category python:view.get_categories_in_poc(poc)">

          <!-- Analysis in POC and Category -->
            <table class="table table-sm">
              <thead>
                <tr>
                  <th class="analysis">
                    <span tal:content="category/Title">Category</span>
                  </th>
                  <th class="text-right result">
                    <span i18n:translate="">Result</span>
                  </th>
                  <th class="text-left unit">
                    <span i18n:translate="">Unit</span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tal:analyses tal:repeat="analysis python:view.get_analyses(poc, category)">
                  <tr>
                    <td class="analysis">
                      <img tal:attributes="src python:view.get_image_resource('accredited.png')"
                           tal:condition="analysis/Accredited"
                           alt="accredited"
                           class="accredited-ico"/>
                      <span tal:condition="not:analysis/ScientificName"
                            tal:content="analysis/title">
                        Total 25-OHD
                      </span>
                      <span tal:condition="analysis/ScientificName">
                        <em tal:content="analysis/title"></em>
                      </span>
                    </td>
                    <td class="text-right">
                      <span class="result" tal:content="structure analysis/Result">23</span>
                    </td>
                    <td class="text-left">
                      <span class="units" tal:content="structure analysis/Unit|nothing"></span>
                    </td>
                  </tr>
                </tal:analyses>
              </tbody>
              <tfoot tal:define="category_comments python:category.Comments">
                <tr tal:condition="category_comments">
                  <td colspan="3">
                    <div class="category_comments"
                         tal:content="category_comments">
                      Category Comments
                    </div>
                  </td>
                </tr>
              </tfoot>
            </table>

        </tal:categories_in_poc>
      </tal:analyses_by_poc>
    </div>
  </div>

  <div class="row section-signatures">
    <div class="col-sm-12">
    </div>
  </div>

  <div class="row section-discreeter">
    <div class="col-sm-12 text-muted font-weight-light small">
      <div class="discreeter-outofrange"
           i18n:translate="">
        * Result out of client specified range.
      </div>
      <div class="discreeter-not-invoiced"
           tal:condition="analysisrequest/InvoiceExclude"
           i18n:translate="">
        Not invoiced
      </div>
      <div class="discreeter-methods"
           tal:condition="laboratory/LaboratoryAccredited"
           i18n:translate="">
        Methods included in the
        <tal:block replace="laboratory/AccreditationBody" i18n:name="accreditation_body"/>
        schedule of Accreditation for this Laboratory. Analysis remarks are not
        accredited
      </div>
      <div class="discreeter-disclaimer"
           i18n:translate="">
        Analysis results relate only to the samples tested.
      </div>
      <div class="discreeter-copyright"
           i18n:translate="">
        This document shall not be reproduced except in full, without the written approval of
        <tal:block replace="laboratory/title" i18n:name="name_lab"/>
      </div>
      <div tal:define="confidence_level laboratory/Confidence"
           tal:condition="confidence_level" i18n:translate="">
        Test results are at a <tal:block replace="confidence_level" i18n:name="lab_confidence"/>% confidence level
      </div>
      <div class="discreeter-linkage"
           tal:condition="python:contact and contact.PublicationPreference != '' and 'email' in contact.PublicationPreference" i18n:translate="">
        Methods of analysis available by clicking on the 'Request' link
      </div>
    </div>
  </div>

</tal:report>
